<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>글 조회</title>
    <style>
        #commentList {
          margin-top: 20px;
        }
        .comment {
          margin-bottom: 10px;
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 5px;
        }
  </style>
</head>
<body>
  <h2>글 조회</h2>

  <div id="blogInfo" th:attr="data-user-id=${userId}, data-nickname=${nickname}" hidden></div>

  <label>블로그 ID</label><br>
  <div id="blog_id" th:text="${post.blog.blogId}"></div><br>

  <label>게시글 ID</label><br>
  <div id="post_id" th:text="${post.postId}" th:attr="data-post-id=${post.postId}"></div><br>

  <label hidden>제목</label><br>
  <div id="title" th:text="'제목 | ' + ${post.title} + '&nbsp;&nbsp;조회수 | ' + ${post.viewCount}"></div><br>

  <label>내용</label><br>
  <div id="content" th:utext="${post.content}"></div><br>
  <div>
    <label>해시태그</label>
    <span th:each="hashtag : ${post.postHashtagPeople}">
      <span th:text="'#' + ${hashtag.hashtagPeople.tagName}">#해시태그</span>
    </span>
  </div>

  <label>좋아요</label><input type="checkbox" id="postLike" th:checked="${exist}"><br> <!--내일 확인할 것-->
  <div id="likeCount" th:text="${post.postLike.size()}"></div><br>

  <button type="button" th:onclick="|location.href='@{/blog/@{nickname}/post(nickname=${nickname})}'|">글 목록</button>
  <button type="button" th:if="${nickname == loginNickname}" th:onclick="|location.href='@{/blog/@{nickname}/post/{id}/edit(nickname=${nickname}, id=${post.postId})}'|">수정</button>
  <button type="button" th:if="${nickname == loginNickname}" id="delete-btn">삭제</button>

  <label>댓글</label>
  <div>
    <span id="username" th:text="${loginNickname}" />
    <input type="text" id="commentInput" placeholder="댓글을 입력하세요" />
    <select id="is_secret">
      <option value="Y">전체 공개</option>
      <option value="N">비공개</option>
    </select>
    <button id="submitComment">등록</button>

    <!-- 댓글 리스트 -->
    <div id="commentList">
      <div th:each="comment : ${commentList}">
        <div class="comment" th:attr="data-comment-id=${comment.commentId}">
          <span th:text="${comment.nickname}"></span>:
          <span th:text="${comment.content}"></span>
          
          <!-- 대댓글 버튼 -->
          <button class="reply-btn">답글</button>
          <!-- 댓글 내 -->
          <button class="delete-comment-btn">삭제</button>


          <!-- 대댓글 입력창 (초기엔 숨김) -->
          <div class="reply-form" style="display:none;">
            <input type="text" class="reply-content" placeholder="답글을 입력하세요" />
            <select class="reply-is_secret">
              <option value="Y">전체 공개</option>
              <option value="N">비공개</option>
            </select>
            <button class="submit-reply">등록</button>
          </div>
        </div>

    <!-- 대댓글 출력 -->
        <div th:if="${comment.commentList != null}">
          <div th:each="child : ${comment.commentList}" style="margin-left: 20px;">
            <div class="comment" th:attr="data-comment-id=${child.commentId}">
              <span th:text="${child.nickname}"></span>:
              <span th:text="${child.content}"></span>

              <!-- 대댓글 버튼 -->
              <button class="reply-btn">답글</button>
              <button class="delete-comment-btn">삭제</button>

              <!-- 대댓글 입력창 (초기엔 숨김) -->
              <div class="reply-form" style="display:none;">
                <input type="text" class="reply-content" placeholder="답글을 입력하세요" />
                <select class="reply-is_secret">
                  <option value="Y">전체 공개</option>
                  <option value="N">비공개</option>
                </select>
                <button class="submit-reply">등록</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!--
  <label>댓글</label>
  <div>
    <span id="username" th:text="${loginNickname}"></span>
    <input type="text" id="commentInput" placeholder="댓글을 입력하세요" />
    <select id="is_secret">
      <option value="Y">전체 공개</option>
      <option value="N">비공개</option>
    </select>
    <button id="submitComment">등록</button>-->

    <!-- 댓글 리스트 --><!--
    <div id="commentList">
      <div th:each="comment : ${commentList}" th:if="${commentList != null}">-->
        <!-- 댓글 + 자식댓글 재귀 출력 --><!--
        <div th:if="${comment != null}" th:replace="~{this :: commentFragment(comment, 0)}"></div>
      </div>
    </div>
  </div>-->

  <!-- 댓글 1개 및 자식 댓글 재귀 렌더링 fragment --><!--
  <div th:fragment="commentFragment(comment, level)" 
      th:with="indent=${(level != null ? level : 0) * 20}" 
      th:style="'margin-left: ' + ${indent} + 'px; border:1px solid #ccc; padding:5px; margin-bottom:5px;'">
    <div class="comment">
      <span><strong th:text="${comment.nickname}">닉네임</strong>:</span>
      <span th:text="${comment.content}">댓글 내용</span>
      <button class="reply-btn">답글</button>
      <button class="delete-comment-btn">삭제</button>-->

      <!-- 대댓글 입력창 (초기엔 숨김) --><!--
      <div class="reply-form" style="display:none;">
        <input type="text" class="reply-content" placeholder="답글을 입력하세요" />
        <select class="reply-is_secret">
          <option value="Y">전체 공개</option>
          <option value="N">비공개</option>
        </select>
        <button class="submit-reply">등록</button>
      </div>
    </div>-->

    <!-- 자식 댓글이 있으면 재귀 호출 --><!--
    <div th:if="${comment.commentList != null}">
      <div th:each="childComment : ${comment.commentList}">
        <div th:if="${comment != null}" th:replace="~{this :: commentFragment(childComment, ${level} + 1)}"></div>
      </div>
    </div>
  </div>-->

  <script>
    const id = document.getElementById('post_id').dataset.postId;
    const userId = document.getElementById('blogInfo').dataset.userId;
    const nickname = document.getElementById('blogInfo').dataset.nickname;

    // 좋아요 추가, 취소
    document.getElementById('postLike').addEventListener('change', function () {
      const isLiked = this.checked;
    
      const data = {
        userId: userId
      }

      fetch(`/api/${id}/like`, {
        method: isLiked ? 'POST' : 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
        })
      .then(res => {
        if (!res.ok) throw new Error("서버 오류");
        return res.json();
      })
      .then(data => {
        console.log(data.message); // 성공 메시지
        document.querySelector('#likeCount').textContent = data.likeCount;
      })
      .catch(err => {
        console.error("오류 발생:", err);
      });
    });

    // 글 삭제
    document.getElementById("delete-btn").addEventListener('click', function(){
      const del = confirm("이 글을 삭제하시겠습니까?");
      if(del == true){
        fetch(`/api/delete/${id}`, {
          method: 'DELETE',
        })
        .then(res => {
          if(!res.ok) throw new Error("삭제 실패");
          alert("삭제되었습니다.");
          location.replace(`/blog/@${nickname}/post`);
        })
        .catch(err => {
          console.error(err.message);
        });
      }
    });

    // 댓글 등록 함수 (수정 버튼 이벤트 제거)
    function addCommentToList(comment) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('comment');
      wrapper.dataset.commentId = comment.commentId;

      wrapper.innerHTML = `
        <strong>${comment.nickname}</strong>:
        <span class="comment-content">${comment.content}</span>
        <button class="edit-btn">수정</button>
        <button class="delete-comment-btn">삭제</button>
        <button class="reply-btn">답글</button>

        <div class="reply-form" style="display:none;">
          <input type="text" class="reply-content" placeholder="답글을 입력하세요" />
          <select class="reply-is_secret">
            <option value="Y">전체 공개</option>
            <option value="N">비공개</option>
          </select>
          <button class="submit-reply">등록</button>
        </div>
      `;

      document.getElementById('commentList').appendChild(wrapper);
    }

    // 댓글 리스트 컨테이너
    const commentList = document.getElementById('commentList');

    commentList.addEventListener('click', (event) => {
      const target = event.target;
      const commentDiv = target.closest('.comment');
      if (!commentDiv) return; // 댓글 영역이 아니면 무시
      const commentId = commentDiv.dataset.commentId;

      // 수정 버튼 클릭
      if (target.classList.contains('edit-btn')) {
        const contentSpan = commentDiv.querySelector('.comment-content');
        const currentContent = contentSpan.textContent;

        contentSpan.innerHTML = `
          <input type="text" class="edit-input" value="${currentContent}" />
          <select class="edit-is_secret">
            <option value="Y">전체 공개</option>
            <option value="N">비공개</option>
          </select>
          <button class="save-btn">저장</button>
          <button class="cancel-btn">취소</button>
        `;

        // 저장 버튼 클릭 이벤트 (한 번만 붙임)
        contentSpan.querySelector('.save-btn').addEventListener('click', () => {
          const newContent = contentSpan.querySelector('.edit-input').value.trim();
          const is_secret = contentSpan.querySelector('.edit-is_secret').value;

          if (!newContent) {
            alert('댓글 내용을 입력해주세요.');
            return;
          }

          fetch(`/api/${commentId}/comment/update`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: newContent, is_secret: is_secret})
          })
          .then(res => {
            if (!res.ok) throw new Error('댓글 수정 실패');
            return res.json();
          })
          .then(updatedComment => {
            contentSpan.textContent = updatedComment.content;
          })
          .catch(err => alert(err.message));
        });

        // 취소 버튼 클릭 이벤트
        contentSpan.querySelector('.cancel-btn').addEventListener('click', () => {
          contentSpan.textContent = currentContent;
        });
      }

      // 삭제 버튼 클릭
      if (target.classList.contains('delete-comment-btn')) {
        if (!commentId) {
          alert("댓글 ID를 찾을 수 없습니다.");
          return;
        }
        const confirmDelete = confirm("이 댓글을 삭제하시겠습니까?");
        if (!confirmDelete) return;

        fetch(`/api/${commentId}/comment`, {
          method: 'DELETE'
        })
        .then(res => {
          if (!res.ok) throw new Error('댓글 삭제 실패');
          return res.text();
        })
        .then(msg => {
          alert(msg);
          commentDiv.remove();

          // 자식 댓글도 삭제
          document.querySelectorAll(`.comment[data-parent-id='${commentId}']`).forEach(child => child.remove());
        })
        .catch(err => alert(err.message));
      }

      // 답글 버튼 클릭 (답글 폼 토글)
      if (target.classList.contains('reply-btn')) {
        const replyForm = commentDiv.querySelector('.reply-form');
        replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
      }

      // 대댓글 등록 버튼 클릭
      if (target.classList.contains('submit-reply')) {
        const content = commentDiv.querySelector('.reply-content').value.trim();
        const isSecret = commentDiv.querySelector('.reply-is_secret').value;

        if (!content) {
          alert('답글 내용을 입력해주세요.');
          return;
        }

        fetch(`/api/${id}/comment`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            userId: userId,
            content: content,
            postId: id,
            isSecret: isSecret,
            parentComment: commentId
          })
        })
        .then(res => {
          if (!res.ok) throw new Error('대댓글 등록 실패');
          return res.json();
        })
        .then(data => {
          location.reload(); // 필요하면 동적 렌더링으로 바꾸세요
        })
        .catch(err => alert(err.message));
      }
    });

    // 댓글 등록 버튼 (기존 코드 유지)
    document.getElementById('submitComment').addEventListener('click', function () {
      const content = document.getElementById('commentInput').value.trim();
      const isSecret = document.getElementById('is_secret').value;

      if (!content) {
        alert('댓글을 입력해주세요.');
        return;
      }

      fetch(`/api/${id}/comment`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          userId: userId,
          content: content,
          postId: id,
          isSecret: isSecret
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('댓글 등록 실패');
        return res.json();
      })
      .then(data => {
        addCommentToList(data);
        document.getElementById('commentInput').value = '';
      })
      .catch(err => alert(err.message));
    });

  </script>
</body>
</html>