<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>ê²Œì‹œê¸€ ì¡°íšŒ</title>

  <!-- ë¸”ë¡œê·¸ í˜ì´ì§€ css ì „ì²´(6, í™ˆ-ìƒì -í”„ë¡œí•„-ê²Œì‹œíŒ-ì£¼í¬ë°•ìŠ¤-ë°©ëª…ë¡) í™ˆì—ì„œ ë¡œë“œ -->
  <link rel="stylesheet" href="/css/home.css" />
  <link rel="stylesheet" href="/css/shop.css" />
  <link rel="stylesheet" href="/css/profile.css" />
  <link rel="stylesheet" href="/css/post.css" />
  <link rel="stylesheet" href="/css/jukebox.css" />
  <link rel="stylesheet" href="/css/guestbook.css" />
  <link rel="stylesheet" href="/css/neighbor.css" />
  <style>
    #commentList {
      margin-top: 20px;
    }

    .comment {
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>

<body onload="initPostDetail()">
  <div class="frame">

    <!-- ì—¬ë°± ì•ˆìª½ì˜ ì‹¤ì œ ë¸”ë¡œê·¸ ì»¨í…ì¸  ì»¨í…Œì´ë„ˆ -->
    <div class="blog-container">

      <!-- ì™¼ìª½ í”„ë¡œí•„ ì‚¬ì´ë“œ (ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œë“œ) -->
      <div id="left-container"></div>

      <!-- ì¤‘ì•™ ë©”ì¸ ì˜ì—­ -->
      <div class="main-area">

        <!-- ìƒë‹¨ í—¤ë” (ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œë“œ) -->
        <div id="top-container"></div>

        <!-- ê²Œì‹œíŒ ì»¨í…ì¸  -->
        <div class="main-content">
          <div id="board-detail">

            <div id="blogInfo"
              th:attr="data-user-id=${userId}, data-nickname=${nickname}, data-login-nickname=${loginNickname}" hidden>
            </div>
            <div id="post_id" th:attr="data-post-id=${post.postId}" hidden></div>
            <div class="post-detail-container">
              <div class="post-header">
                <h2 id="detail-title" th:text="${post.title}">ê²Œì‹œê¸€ ì œëª©</h2>
                <div class="meta">
                  <span id="detail-author" th:text="${nickname}">ë‹‰ë„¤ì„</span> | <span
                    th:text="${post.viewCount}">ì¡°íšŒìˆ˜</span> | <span id="detail-date"
                    th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì‹œê°„</span>
                  <span th:if="${post.createdAt != post.updatedAt}"
                    th:text="${#temporals.format(post.updatedAt, 'yyyy-MM-dd HH:mm')}">ìˆ˜ì •ì‹œê°„</span>
                </div>
              </div>

              <div class="post-body">
                <div id="detail-content" th:utext="${post.content}"></div><br>
                <div id="detail-tags" style="margin-top: 15px; color: #b865a4;">
                  <span th:each="hashtag : ${post.postHashtagPeople}">
                    <span th:text="'#' + ${hashtag.hashtagPeople.tagName}">#í•´ì‹œíƒœê·¸</span>
                  </span>
                </div>
              </div>

              <div class="post-actions">
                <button id="addPostLike" type="button" onclick="addPostLike()" th:style="${exist} ? 'display:none;' : 'display:inline-block;'">
                  ì¢‹ì•„ìš” <span id="like-count-add" th:text="${post.postLike.size()}">0</span>
                </button>
                <button id="delPostLike" type="button" onclick="delPostLike()" th:style="${exist} ? 'display:inline-block;' : 'display:none;'">
                  â¤ï¸ ì¢‹ì•„ìš” <span id="like-count-del" th:text="${post.postLike.size()}">0</span>
                </button>
                <button type="button" onclick="navigateToPage('post')">ê¸€ ëª©ë¡</button>
                <button type="button" th:if="${nickname == loginNickname}"

                  th:onclick="|location.href='@{/blog/@{nickname}/post/{id}/edit(nickname=${nickname}, id=${post.postId})}'|">âœï¸
                  ìˆ˜ì •</button>

                <button type="button" onclick="delPost()" th:if="${nickname == loginNickname}" id="delete-btn">ğŸ—‘ ì‚­ì œ</button>
              </div>

              <div class="comments-section">
                <h3>ğŸ’¬ ëŒ“ê¸€ (<span id="detail-comments-count">0</span>)</h3>
                <textarea placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." id="comment-input"></textarea>
                <select id="is_secret">
                  <option value="N">ì „ì²´ ê³µê°œ</option>
                  <option value="Y">ë¹„ê³µê°œ</option>
                </select>
                <button id="submitComment" class="comment-btn" onclick="addComment()">ëŒ“ê¸€ ë‹¬ê¸°</button>
                <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
                <ul class="comment-list" id="detail-comments">
                  <!-- ëŒ“ê¸€ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ì˜¤ë¥¸ìª½ ë„¤ë¹„ê²Œì´ì…˜ (ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œë“œ) -->
      <div id="right-container"></div>
    </div>
  </div>

  <script>
    let id = document.getElementById('post_id').dataset.postId;
    let userId = document.getElementById('blogInfo').dataset.userId;
    let nickname = document.getElementById('blogInfo').dataset.nickname;
    let loginNickname = document.getElementById('blogInfo').dataset.loginNickname;

    let addLikeBtn = document.getElementById('addPostLike');
    let delLikeBtn = document.getElementById('delPostLike');

    // ì¢‹ì•„ìš” ì¶”ê°€
    function addPostLike(){
      fetch(`/api/${id}/like`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: userId })
      })
      .then(res => {
        if(!res.ok) return;
        return res.json()
      })
      .then(data => {
        if (!data) return;
        console.log(data.message);
        document.querySelector('#like-count-add').textContent = data.likeCount;
        document.querySelector('#like-count-del').textContent = data.likeCount;
        addLikeBtn.style.display = 'none';
        delLikeBtn.style.display = 'inline-block';
      })
      .catch(err => {
        console.error('ì¢‹ì•„ìš” ì¶”ê°€ ì‹¤íŒ¨:', err);
      });
    }

    // ì¢‹ì•„ìš” ì œê±°
    function delPostLike() {
      fetch(`/api/${id}/like`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: userId })
      })
      .then(res => {
        if(!res.ok) return;
        return res.json();
      })
      .then(data => {
        if (!data) return;
        console.log(data.message);
        document.querySelector('#like-count-add').textContent = data.likeCount;
        document.querySelector('#like-count-del').textContent = data.likeCount;
          addLikeBtn.style.display = 'inline-block';
          delLikeBtn.style.display = 'none';
      })
      .catch(err => {
        console.error('ì¢‹ì•„ìš” ì œê±° ì‹¤íŒ¨:', err);
      });
    }

    // ê¸€ ì‚­ì œ
    let deleteBtn = document.getElementById("delete-btn");
    function delPost() {
      const del = confirm("ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (del == true) {
        fetch(`/api/delete/${id}`, {
          method: 'DELETE',
        })
        .then(res => {
        if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.replace(`/blog/@${nickname}/post`);
        })
        .catch(err => {
          console.error(err.message);
        });
      }
    }
    

    // ëŒ“ê¸€ ë“±ë¡
    let submitComment = document.getElementById('submitComment');
    function addComment() {
      const content = document.getElementById('comment-input').value.trim();
      const isSecret = document.getElementById('is_secret').value;

      if (!content) {
        alert('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!isSecret) {
        alert('ê³µê°œ ì„¤ì •ì„ í•´ì£¼ì„¸ìš”');
        return;
      }

      fetch(`/api/${id}/comment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: userId,
          content: content,
          postId: id,
          isSecret: isSecret
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
        return res.json();
      })
      .then(data => {
        fetchComments(id);
        document.getElementById('comment-input').value = '';
      })
      .catch(err => alert(err.message));
    }

    // ëŒ“ê¸€ ìˆ˜ì •
    function editComment(commentId) {
      const li = document.querySelector(`[data-comment-id="${commentId}"]`);
      if (!li) return;

      // í˜„ì¬ ëŒ“ê¸€ í…ìŠ¤íŠ¸ ìš”ì†Œ ì„ íƒ
      const contentSpan = li.querySelector('span');
      if (!contentSpan) return;

      const currentContent = contentSpan.textContent.trim();
      const isSecretValue = li.dataset.isSecret;

      // í¸ì§‘ UI ë§Œë“¤ê¸°
      li.innerHTML = `
          <textarea class="edit-input" style="width: 70%;">${currentContent}</textarea>
          <select class="is-secret">
            <option value="N" ${isSecretValue === 'N' ? 'selected' : ''}>ì „ì²´ ê³µê°œ</option>
            <option value="Y" ${isSecretValue === 'Y' ? 'selected' : ''}>ë¹„ê³µê°œ</option>
          </select>
          <button class="save-btn" style="color:#b865a4;">ì €ì¥</button>
          <button class="cancel-btn" style="color:#b865a4;">ì·¨ì†Œ</button>
      `;

      // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
      li.querySelector('.save-btn').addEventListener('click', () => {
        const newContent = li.querySelector('.edit-input').value.trim();
        const isSecret = li.querySelector('.is-secret').value;
        if (!newContent) {
          alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        if (!isSecret) {
          alert('ê³µê°œ ì„¤ì •ì„ í•´ì£¼ì„¸ìš”');
          return;
        }

        fetch(`/api/${commentId}/comment/update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            content: newContent,
            isSecret: isSecret
          })
        })
          .then(res => {
            if (!res.ok) throw new Error('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨');
            return res.json();
          })
          .then(() => {
            fetchComments(id); // ëŒ“ê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          })
          .catch(err => alert(err.message));
      });

      // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ (ì›ë˜ ë‚´ìš© ë³µì›)
      li.querySelector('.cancel-btn').addEventListener('click', () => {
        fetchComments(id);
      });
    }

    // ëŒ“ê¸€ ì‚­ì œ
    function deleteComment(commentId) {
      if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      fetch(`/api/${commentId}/comment`, {
        method: 'DELETE'
      })
        .then(res => {
          if (!res.ok) throw new Error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
          document.querySelector(`[data-comment-id="${commentId}"]`).remove();
        })
        .catch(error => {
          console.error(error);
          alert("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }

    // ëŒ“ê¸€ ì¡°íšŒ
    async function fetchComments(postId) {
      try {
        console.log('fetch URL:', `/api/comments?postId=${postId}`);
        const response = await fetch(`/api/${postId}/comments`);
        if (!response.ok) throw new Error('ëŒ“ê¸€ ë¡œë”© ì‹¤íŒ¨');

        const comments = await response.json();
        console.log(comments);
        const commentsList = document.getElementById('detail-comments');
        commentsList.innerHTML = '';
        renderComments(comments, commentsList);
      } catch (error) {
        console.error(error);
        alert('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëŒ“ê¸€ ë Œë”ë§
    function renderComments(comments, container = document.getElementById('detail-comments')) {
      container.innerHTML = '';
      comments.forEach(comment => {
        const li = document.createElement('li');
        li.dataset.commentId = comment.commentId;
        li.dataset.isSecret = comment.isSecret;
        let contentToShow = '';
        
        // ë¡œê·¸ì¸ ìœ ì €ì™€ ëŒ“ê¸€ ì‘ì„±ì ë¹„êµ
        const isPostAuthor = (loginNickname === nickname);
        const isAuthor = (comment.nickname === loginNickname); // userIdëŠ” ë¡œê·¸ì¸í•œ ìœ ì € id
        if (comment.isSecret === 'N') {
          contentToShow = comment.content;
        } else {
          contentToShow = (isAuthor || isPostAuthor) ? comment.content : 'ë¹„ë°€ ëŒ“ê¸€ ì…ë‹ˆë‹¤';
        }
        li.innerHTML = `
            <div class="comment-header">
              <div class="comment-head">
                <strong>${comment.nickname}</strong>
                <div class="comment-date">
                  ${comment.createdAt} 
                  ${comment.createdAt !== comment.updatedAt ? ` ${comment.updatedAt}(ìˆ˜ì •)` : ''}
                </div>
              </div>
              <div class="comment-button">
                ${isAuthor ? `
                    <button onclick="editComment('${comment.commentId}')" style="color:#b865a4;">ìˆ˜ì •</button>
                    <button onclick="deleteComment('${comment.commentId}')" style="color:#b865a4;">ì‚­ì œ</button>
                ` : ''}
                ${comment.liked ?
            `<button onclick="delLikeComment('${comment.commentId}')" style="color:#b865a4;">â¤ï¸ ${comment.commentLikeCount}</button>` :
            `<button onclick="addLikeComment('${comment.commentId}')" style="color:#b865a4;">ğŸ¤ ${comment.commentLikeCount}</button>`
          }                
                <button onclick="showReplyForm(this)" style="color:#b865a4;">ë‹µê¸€</button>
              </div>
            </div>
            
            <div class="comment-content">
              <span>${contentToShow}</span>
            </div>
        `;
        container.appendChild(li);

        if (Array.isArray(comment.commentList) && comment.commentList.length > 0) {
          const ul = document.createElement('ul');
          ul.style.marginLeft = '20px';
          li.after(ul);
          renderComments(comment.commentList, ul);
        }
      });
      // ëŒ“ê¸€ ì´ ê°¯ìˆ˜
      const totalCount = countAllComments(comments);
      document.getElementById('detail-comments-count').textContent = totalCount;
    }

    function countAllComments(comments) {
      let count = 0;
      for (const comment of comments) {
        count += 1;
        if (Array.isArray(comment.commentList)) {
          count += countAllComments(comment.commentList);
        }
      }
      return count;
    }

    /*
        // ëŒ“ê¸€ ì¢‹ì•„ìš”
        function likeComment(button) {
            // ê°„ë‹¨í•œ ì¢‹ì•„ìš” íš¨ê³¼
            button.style.color = '#ff6b6b';
            setTimeout(() => {
                button.style.color = '';
            }, 1000);
        }
    */


    // ëŒ“ê¸€ ì¢‹ì•„ìš” ì¶”ê°€
    function addLikeComment(commentId) {
      console.log("ğŸ§ª Like ìš”ì²­ commentId:", commentId);
      fetch(`/api/${commentId}/commentlike`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          memberId: userId,
          commentId: commentId
        })
      })
        .then(response => {
          if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì—ëŸ¬');
          return response.text(); // ë¹ˆ ë°”ë””ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ text() ì‚¬ìš©
        })
        .then(data => {
          console.log(data.message);
          fetchComments(id);
        });
    }

    // ëŒ“ê¸€ ì¢‹ì•„ìš” ì œê±°
    function delLikeComment(commentId) {
      console.log("ğŸ§ª Like ìš”ì²­ commentId:", commentId);
      fetch(`/api/${commentId}/commentlike`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          memberId: userId,
          commentId: commentId
        })
      })
        .then(response => {
          if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì—ëŸ¬');
          return response.text(); // ë¹ˆ ë°”ë””ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ text() ì‚¬ìš©
        })
        .then(data => {
          console.log(data.message);
          fetchComments(id);
        });
    }

    // ë‹µê¸€ ë²„íŠ¼
    function showReplyForm(button) {
      const parentLi = button.closest('li');
      const parentCommentId = parentLi.dataset.commentId;

      // ì¤‘ë³µ ë°©ì§€
      if (parentLi.querySelector('.reply-form')) {
        parentLi.querySelector('.reply-form').remove();
        return;
      }

      const form = document.createElement('div');
      form.className = 'reply-form';
      form.innerHTML = `
          <textarea class="reply-input" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          <select class="reply-secret">
            <option value="N">ì „ì²´ ê³µê°œ</option>
            <option value="Y">ë¹„ê³µê°œ</option>
          </select>
          <button class="submit-reply">ë“±ë¡</button>
          <button class="cancel-btn">ì·¨ì†Œ</button>
      `;

      parentLi.after(form);

      // ëŒ€ëŒ“ê¸€ ë“±ë¡
      form.querySelector('.submit-reply').addEventListener('click', () => {
        const content = form.querySelector('.reply-input').value.trim();
        const isSecret = form.querySelector('.reply-secret').value;

        if (!content) {
          alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        if (!isSecret) {
          alert('ê³µê°œ ì„¤ì •ì„ í•´ì£¼ì„¸ìš”');
          return;
        }

        fetch(`/api/${id}/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: userId,
            postId: id,
            content: content,
            isSecret: isSecret,
            parentComment: parentCommentId
          })
        })
          .then(res => {
            if (!res.ok) throw new Error('ëŒ€ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
            return res.json();
          })
          .then(data => {
            form.remove(); // í¼ ë‹«ê¸°
            fetchComments(id); // ì „ì²´ ëŒ“ê¸€ ìƒˆë¡œê³ ì¹¨
          })
          .catch(err => alert(err.message));
      });

      // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ (ì›ë˜ ë‚´ìš© ë³µì›)
      form.querySelector('.cancel-btn').addEventListener('click', () => {
        fetchComments(id);
      });
    }

    function initPostDetail() {
      // DOMì—ì„œ ìµœì‹  ë°ì´í„° ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
      id = document.getElementById('post_id').dataset.postId;
      userId = document.getElementById('blogInfo').dataset.userId;
      nickname = document.getElementById('blogInfo').dataset.nickname;
      loginNickname = document.getElementById('blogInfo').dataset.loginNickname;
      console.log('initPostDetail - id:', id, 'userId:', userId, 'nickname:', nickname, 'loginNickname:', loginNickname);

      addLikeBtn = document.getElementById('addPostLike');
      delLikeBtn = document.getElementById('delPostLike');
      deleteBtn = document.getElementById("delete-btn");
      submitComment = document.getElementById('submitComment');

      // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      const commentList = document.getElementById('detail-comments');
      if (commentList) commentList.innerHTML = '';

      // ëŒ“ê¸€ ìˆ˜ ì´ˆê¸°í™”
      const commentCount = document.getElementById('detail-comments-count');
      if (commentCount) commentCount.textContent = '0';
      fetchComments(id);
      // ì¢‹ì•„ìš” ì´ˆê¸°í™” ë“± í•„ìš”í•œ ê²ƒë“¤ ì´ê³³ì— ì¶”ê°€
    }
    

  </script>

  <!-- ë ˆì´ì•„ì›ƒ + ë¸”ë¡œê·¸ í˜ì´ì§€ js ì „ì²´(7, í™ˆ-ìƒì -í”„ë¡œí•„-ê²Œì‹œíŒ-ì£¼í¬ë°•ìŠ¤-ë°©ëª…ë¡) í™ˆì—ì„œ ë¡œë“œ -->
  <script src="/js/layout.js"></script>
  <script src="/js/home.js"></script>
  <script src="/js/shop.js"></script>
  <script src="/js/profile.js"></script>
  <script src="/js/post.js"></script>
  <script src="/js/jukebox.js"></script>
  <script src="/js/guestbook.js"></script>
  <script src="/js/neighbor.js"></script>

</body>

</html>