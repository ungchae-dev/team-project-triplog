<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê¸€ ì¡°íšŒ</title>
  <!-- ë¸”ë¡œê·¸ í˜ì´ì§€ css ì „ì²´(7, í™ˆ-ìƒì -í”„ë¡œí•„-ê²Œì‹œíŒ-ì£¼í¬ë°•ìŠ¤-ë§ˆì´ë¡œê·¸-ë°©ëª…ë¡) í™ˆì—ì„œ ë¡œë“œ -->
  <link rel="stylesheet" href="/css/home.css" />
  <link rel="stylesheet" href="/css/shop.css" />
  <link rel="stylesheet" href="/css/profile.css" />
  <link rel="stylesheet" href="/css/post.css" />
  <link rel="stylesheet" href="/css/jukebox.css" />
  <link rel="stylesheet" href="/css/mylog.css" />
  <link rel="stylesheet" href="/css/guestbook.css" />
  <style>
    #commentList {
      margin-top: 20px;
    }
    .comment {
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="frame">

    <!-- ì—¬ë°± ì•ˆìª½ì˜ ì‹¤ì œ ë¸”ë¡œê·¸ ì»¨í…ì¸  ì»¨í…Œì´ë„ˆ -->
    <div class="blog-container">

      <!-- ì™¼ìª½ í”„ë¡œí•„ ì‚¬ì´ë“œ (ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œë“œ) -->
      <div id="left-container"></div>

      <!-- ì¤‘ì•™ ë©”ì¸ ì˜ì—­ -->
      <div class="main-area">

        <!-- ìƒë‹¨ í—¤ë” (ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œë“œ) -->
        <div id="top-container"></div>

        <!-- ê²Œì‹œíŒ ì»¨í…ì¸  -->
        <div class="main-content">
          <div id="board-detail">

            <div id="blogInfo" th:attr="data-user-id=${userId}, data-nickname=${nickname}" hidden></div>
            <div id="post_id" th:attr="data-post-id=${post.postId}" hidden></div>
            <div class="post-detail-container">
              <div class="post-header">
                <h2 id="detail-title" th:text="${post.title}">ê²Œì‹œê¸€ ì œëª©</h2>
                <div class="meta">
                  <span id="detail-author" th:text="${nickname}">ë‹‰ë„¤ì„</span> | <span th:text="${post.viewCount}">ì¡°íšŒìˆ˜</span> | <span id="detail-date" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì‹œê°„</span>
                  <span th:if="${post.createdAt != post.updatedAt}" th:text="${#temporals.format(post.updatedAt, 'yyyy--MM--dd HH:mm')}">ìˆ˜ì •ì‹œê°„</span>
                </div>
              </div>

              <div class="post-body">
                <div id="detail-content" th:utext="${post.content}"></div><br>
                <div id="detail-tags" style="margin-top: 15px; color: #b865a4;">
                  <span th:each="hashtag : ${post.postHashtagPeople}">
                    <span th:text="'#' + ${hashtag.hashtagPeople.tagName}">#í•´ì‹œíƒœê·¸</span>
                  </span>
                </div>
              </div>
            
              <div class="post-actions">
                <button id="addPostLike" type="button" 
                    th:style="${exist} ? 'display:none;' : 'display:inline-block;'">
                  ì¢‹ì•„ìš” <span id="like-count-add" th:text="${post.postLike.size()}">0</span>
                </button>
                <button id="delPostLike" type="button" 
                    th:style="${exist} ? 'display:inline-block;' : 'display:none;'">
                  â¤ï¸ ì¢‹ì•„ìš” <span id="like-count-del" th:text="${post.postLike.size()}">0</span>
                </button>
                <button type="button" onclick="navigateToPage('post')">ê¸€ ëª©ë¡</button>
                <button type="button" th:if="${nickname == loginNickname}" th:onclick="|location.href='@{/blog/@{nickname}/post/{id}/edit(nickname=${nickname}, id=${post.postId})}'|">âœï¸ ìˆ˜ì •</button>
                <button type="button" th:if="${nickname == loginNickname}" id="delete-btn">ğŸ—‘ ì‚­ì œ</button>
              </div>
              <label>ëŒ“ê¸€</label>
              <div class="comments-section">
                <h3>ğŸ’¬ ëŒ“ê¸€ (<span id="detail-comments-count" th:text="${commentList.size()}">0</span>)</h3>
                <span id="username" th:text="${loginNickname}" />
                <input type="text" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" />
                <select id="is_secret">
                  <option value="Y">ì „ì²´ ê³µê°œ</option>
                  <option value="N">ë¹„ê³µê°œ</option>
                </select>
                <button id="submitComment">ë“±ë¡</button>

                <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
                <ul class="comment-list" id="detail-comments">
                  <!-- ëŒ“ê¸€ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
                <textarea placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." id="comment-input"></textarea>
                <button class="comment-btn">ëŒ“ê¸€ ë‹¬ê¸°</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ì˜¤ë¥¸ìª½ ë„¤ë¹„ê²Œì´ì…˜ (ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œë“œ) -->
      <div id="right-container"></div>
    </div>
  </div>

  <script>
    const id = document.getElementById('post_id').dataset.postId;
    const userId = document.getElementById('blogInfo').dataset.userId;
    const nickname = document.getElementById('blogInfo').dataset.nickname;

    // ì¢‹ì•„ìš” ì¶”ê°€, ì œê±°
    const addLikeBtn = document.getElementById('addPostLike');
    const delLikeBtn = document.getElementById('delPostLike');

    if (addLikeBtn) {
      addLikeBtn.addEventListener('click', () => {
        fetch(`/api/${id}/like`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId })
        })
        .then(res => res.json())
        .then(data => {
          console.log(data.message);
          document.querySelector('#like-count-del').textContent = data.likeCount;
          //location.reload(); // UIë¥¼ ê°±ì‹ í•˜ë ¤ë©´ reload ë˜ëŠ” ë™ì  í† ê¸€
          addLikeBtn.style.display = 'none';
          delLikeBtn.style.display = 'inline-block';
        });
      });
    }

    if (delLikeBtn) {
      delLikeBtn.addEventListener('click', () => {
        fetch(`/api/${id}/like`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId })
        })
        .then(res => res.json())
        .then(data => {
          console.log(data.message);
          document.querySelector('#like-count-add').textContent = data.likeCount;
          //location.reload();
          addLikeBtn.style.display = 'inline-block';
          delLikeBtn.style.display = 'none';
        });
      });
    }

    // ê¸€ ì‚­ì œ
    document.getElementById("delete-btn").addEventListener('click', function(){
      const del = confirm("ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if(del == true){
        fetch(`/api/delete/${id}`, {
          method: 'DELETE',
        })
        .then(res => {
          if(!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
          alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          location.replace(`/blog/@${nickname}/post`);
        })
        .catch(err => {
          console.error(err.message);
        });
      }
    });
/*
    // ëŒ“ê¸€ ë“±ë¡ í•¨ìˆ˜ (ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ì œê±°)
    function addCommentToList(comment) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('comment');
      wrapper.dataset.commentId = comment.commentId;

      wrapper.innerHTML = `
        <strong>${comment.nickname}</strong>:
        <span class="comment-content">${comment.content}</span>
        <button class="edit-btn">ìˆ˜ì •</button>
        <button class="delete-comment-btn">ì‚­ì œ</button>
        <button class="reply-btn">ë‹µê¸€</button>

        <div class="reply-form" style="display:none;">
          <input type="text" class="reply-content" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" />
          <select class="reply-is_secret">
            <option value="Y">ì „ì²´ ê³µê°œ</option>
            <option value="N">ë¹„ê³µê°œ</option>
          </select>
          <button class="submit-reply">ë“±ë¡</button>
        </div>
      `;

      document.getElementById('commentList').appendChild(wrapper);
    }

    // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ
    const commentList = document.getElementById('commentList');

    commentList.addEventListener('click', (event) => {
      const target = event.target;
      const commentDiv = target.closest('.comment');
      if (!commentDiv) return; // ëŒ“ê¸€ ì˜ì—­ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ
      const commentId = commentDiv.dataset.commentId;

      // ìˆ˜ì • ë²„íŠ¼ í´ë¦­
      if (target.classList.contains('edit-btn')) {
        const contentSpan = commentDiv.querySelector('.comment-content');
        const currentContent = contentSpan.textContent;

        contentSpan.innerHTML = `
          <input type="text" class="edit-input" value="${currentContent}" />
          <select class="edit-is_secret">
            <option value="Y">ì „ì²´ ê³µê°œ</option>
            <option value="N">ë¹„ê³µê°œ</option>
          </select>
          <button class="save-btn">ì €ì¥</button>
          <button class="cancel-btn">ì·¨ì†Œ</button>
        `;

        // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (í•œ ë²ˆë§Œ ë¶™ì„)
        contentSpan.querySelector('.save-btn').addEventListener('click', () => {
          const newContent = contentSpan.querySelector('.edit-input').value.trim();
          const is_secret = contentSpan.querySelector('.edit-is_secret').value;

          if (!newContent) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }

          fetch(`/api/${commentId}/comment/update`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: newContent, is_secret: is_secret})
          })
          .then(res => {
            if (!res.ok) throw new Error('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨');
            return res.json();
          })
          .then(updatedComment => {
            contentSpan.textContent = updatedComment.content;
          })
          .catch(err => alert(err.message));
        });

        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        contentSpan.querySelector('.cancel-btn').addEventListener('click', () => {
          contentSpan.textContent = currentContent;
        });
      }

      // ì‚­ì œ ë²„íŠ¼ í´ë¦­
      if (target.classList.contains('delete-comment-btn')) {
        if (!commentId) {
          alert("ëŒ“ê¸€ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const confirmDelete = confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (!confirmDelete) return;

        fetch(`/api/${commentId}/comment`, {
          method: 'DELETE'
        })
        .then(res => {
          if (!res.ok) throw new Error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
          return res.text();
        })
        .then(msg => {
          alert(msg);
          commentDiv.remove();

          // ìì‹ ëŒ“ê¸€ë„ ì‚­ì œ
          document.querySelectorAll(`.comment[data-parent-id='${commentId}']`).forEach(child => child.remove());
        })
        .catch(err => alert(err.message));
      }

      // ë‹µê¸€ ë²„íŠ¼ í´ë¦­ (ë‹µê¸€ í¼ í† ê¸€)
      if (target.classList.contains('reply-btn')) {
        const replyForm = commentDiv.querySelector('.reply-form');
        replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
      }

      // ëŒ€ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ í´ë¦­
      if (target.classList.contains('submit-reply')) {
        const content = commentDiv.querySelector('.reply-content').value.trim();
        const isSecret = commentDiv.querySelector('.reply-is_secret').value;

        if (!content) {
          alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        fetch(`/api/${id}/comment`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            userId: userId,
            content: content,
            postId: id,
            isSecret: isSecret,
            parentComment: commentId
          })
        })
        .then(res => {
          if (!res.ok) throw new Error('ëŒ€ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
          return res.json();
        })
        .then(data => {
          location.reload(); // í•„ìš”í•˜ë©´ ë™ì  ë Œë”ë§ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”
        })
        .catch(err => alert(err.message));
      }
    });

    // ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    document.getElementById('submitComment').addEventListener('click', function () {
      const content = document.getElementById('commentInput').value.trim();
      const isSecret = document.getElementById('is_secret').value;

      if (!content) {
        alert('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      fetch(`/api/${id}/comment`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          userId: userId,
          content: content,
          postId: id,
          isSecret: isSecret
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
        return res.json();
      })
      .then(data => {
        addCommentToList(data);
        document.getElementById('commentInput').value = '';
      })
      .catch(err => alert(err.message));
    });
*/

async function fetchComments(postId) {
  try {
    const response = await fetch(`/api/${postId}/comments`);
    if (!response.ok) {
      throw new Error('ëŒ“ê¸€ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
    const comments = await response.json();
    renderComments(comments);
  } catch (error) {
    console.error(error);
    alert('ëŒ“ê¸€ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

  // ëŒ“ê¸€ ë Œë”ë§
function renderComments(comments) {
    const commentsList = document.getElementById('detail-comments');
    commentsList.innerHTML = '';

    comments.forEach(comment => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span><strong>${comment.nickname}</strong>: ${comment.content}</span>
            <button onclick="likeComment(this)" style="background:none;border:none;cursor:pointer;">â¤ï¸</button>
            <button onclick="showReplyForm(this)" style="background:none;border:none;cursor:pointer;color:#b865a4;">ë‹µê¸€</button>
        `;
        commentsList.appendChild(li);

        // ë‹µê¸€ì´ ìˆìœ¼ë©´ ë Œë”ë§
        if (comment.replies) {
            comment.replies.forEach(reply => {
                const replyLi = document.createElement('li');
                replyLi.className = 'reply';
                replyLi.innerHTML = `<span><strong>${reply.author}</strong>: ${reply.content}</span>`;
                commentsList.appendChild(replyLi);
            });
        }
    });
}

// ëŒ“ê¸€ ì¢‹ì•„ìš”
function likeComment(button) {
    // ê°„ë‹¨í•œ ì¢‹ì•„ìš” íš¨ê³¼
    button.style.color = '#ff6b6b';
    setTimeout(() => {
        button.style.color = '';
    }, 1000);
}

// ë‹µê¸€ í¼ í‘œì‹œ (ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸ë¡œ êµ¬í˜„)
function showReplyForm(button) {
    const reply = prompt('ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”:');
    if (reply && reply.trim()) {
        alert('ë‹µê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: ' + reply);
        // ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ ì„œë²„ì— ë‹µê¸€ì„ ì €ì¥í•˜ê³  í™”ë©´ì„ ì—…ë°ì´íŠ¸
    }
}
  </script>
  <!-- ë ˆì´ì•„ì›ƒ + ë¸”ë¡œê·¸ í˜ì´ì§€ js ì „ì²´(7, í™ˆ-ìƒì -í”„ë¡œí•„-ê²Œì‹œíŒ-ì£¼í¬ë°•ìŠ¤-ë§ˆì´ë¡œê·¸-ë°©ëª…ë¡) í™ˆì—ì„œ ë¡œë“œ -->
  <script src="/js/layout.js"></script>

</body>
</html>