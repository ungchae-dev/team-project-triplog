<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>커뮤니티 글 작성</title>
  <style>
    #editor {
      border: 1px solid #ccc;
      min-height: 300px;
      padding: 10px;
    }

    #editor img {
      max-width: 600px;
      height: auto;
    }

    .delete-btn {
      position: fixed;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 12px;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      cursor: pointer;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
<h2>글 작성</h2>
<form id="postForm">
  <label>제목</label><br>
  <input type="text" id="title" required><br><br>

  <label>내용</label><br>
  <div id="editor" contenteditable="true"></div><br>
  <button id="deleteBtn" class="delete-btn" type="button">×</button>

  <input type="file" id="imageInput" accept="image/*"><br><br>

  <input type="radio" name="visibility" value="public" checked>전체 공개
  <input type="radio" name="visibility" value="private">비공개

  <button type="submit">작성</button>
</form>

<script>
  const editor = document.getElementById('editor');
  const imageInput = document.getElementById('imageInput');
  const deleteBtn = document.getElementById('deleteBtn');
  let currentImage = null;

  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (!file) return;

    // 이미지 사이즈 제한 (예: 2MB)
    if (file.size > 2 * 1024 * 1024) {
      alert('이미지 크기는 최대 2MB까지 가능합니다.');
      imageInput.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.maxWidth = '600px';
      img.style.height = 'auto';

      const br = document.createElement('br');
      insertAtCursor(br);
      insertAtCursor(img);
      insertAtCursor(document.createElement('br'));

      imageInput.value = '';
    };
    reader.readAsDataURL(file);
  });

  function insertAtCursor(node) {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    const range = selection.getRangeAt(0);
    range.deleteContents();
    range.insertNode(node);

    range.setStartAfter(node);
    range.setEndAfter(node);
    selection.removeAllRanges();
    selection.addRange(range);
  }

  editor.addEventListener('click', function (e) {
    if (e.target.tagName === 'IMG') {
      currentImage = e.target;
      const rect = e.target.getBoundingClientRect();
      deleteBtn.style.top = `${rect.top}px`;
      deleteBtn.style.left = `${rect.left + rect.width - 10}px`;
      deleteBtn.style.display = 'block';
    } else {
      deleteBtn.style.display = 'none';
      currentImage = null;
    }
  });

  deleteBtn.addEventListener('click', function () {
    if (currentImage) {
      currentImage.remove();
      deleteBtn.style.display = 'none';
      currentImage = null;
    }
  });

  document.getElementById('postForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const title = document.getElementById('title').value;
    const content = editor.innerHTML;
    const visibility = document.querySelector('input[name="visibility"]:checked').value;
    // 확인용 블로그 아이디 설정
    const blog_Id = 1;

    const data = {
      title,
      content,
      visibility,
      blog_Id
    };



    const res = await fetch(`/api/write`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      alert('글 작성 완료!');
      location.replace = `post/list`;
    } else {
      alert('작성 실패');
    }
  });
</script>
</body>
</html>
