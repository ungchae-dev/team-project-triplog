<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>ì´ëª¨í‹°ì½˜ ìƒì </title>
  <style>
    .package-card {
      display: inline-block;
      text-align: center;
      margin: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      width: 140px;
    }
    .package-img { width: 120px; cursor: pointer; }
    .sticker-img { width: 80px; margin: 5px; }
    .buy-btn {
      margin-top: 5px;
      padding: 5px 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    .buy-btn[disabled] {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <h2>âœ¨ ì´ëª¨í‹°ì½˜ íŒ¨í‚¤ì§€</h2>
  <div id="package-list"></div>

  <hr />

  <h2>ğŸ“¦ ì„ íƒí•œ íŒ¨í‚¤ì§€ì˜ ìŠ¤í‹°ì»¤</h2>
  <div id="sticker-list"></div>

  <script>
  // 1. íŒ¨í‚¤ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  fetch('/api/emoticon/selected')
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('package-list');
      container.innerHTML = '';
      data.forEach(pkg => {
        // êµ¬ë§¤ ì—¬ë¶€ í™•ì¸
        fetch(`/api/emoticon/purchased?emoticonId=${pkg.emoticonId}`)
          .then(res => res.json())
          .then(isPurchased => {
            const div = document.createElement('div');
            div.className = 'package-card';

            const img = document.createElement('img');
            img.src = pkg.packageImg;
            img.className = 'package-img';
            img.alt = pkg.packageName;
            img.onclick = () => loadStickers(pkg.packageId);
            div.appendChild(img);

            const name = document.createElement('div');
            name.textContent = pkg.packageName;
            div.appendChild(name);

            const price = document.createElement('div');
            price.textContent = `ğŸ’° ${pkg.price} ë„í† ë¦¬`;
            div.appendChild(price);

            const btn = document.createElement('button');
            btn.className = 'buy-btn';
            btn.textContent = isPurchased ? 'êµ¬ë§¤ ì™„ë£Œ' : 'êµ¬ë§¤';
            btn.disabled = isPurchased;
            btn.onclick = () => buyEmoticon(pkg);
            div.appendChild(btn);

            container.appendChild(div);
          });
      });
    });

  // 2. íŠ¹ì • íŒ¨í‚¤ì§€ í´ë¦­ ì‹œ ìŠ¤í‹°ì»¤ ë¡œë“œ
  function loadStickers(packageId) {
    fetch(`/api/emoticon/stickers?packageId=${packageId}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('sticker-list');
        container.innerHTML = '';
        data.forEach(sticker => {
          const img = document.createElement('img');
          img.src = sticker.stickerImg_300;
          img.className = 'sticker-img';
          container.appendChild(img);
        });
      });
  }

  // 3. ì´ëª¨í‹°ì½˜ êµ¬ë§¤ ìš”ì²­
  function buyEmoticon(emoticon) {
  const payload = {
    emoticonId: emoticon.emoticonId,
    emoticonName: emoticon.packageName,
    emoticonImage: emoticon.packageImg,
    price: emoticon.price
  };

  fetch('/api/emoticon/buy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
    .then(res => {
      if (!res.ok) {
        return res.text().then(text => { throw new Error(text); });
      }
      return res.json(); // âœ… JSON ì‘ë‹µ í•œ ë²ˆë§Œ íŒŒì‹±
    })
    .then(data => {
      alert(`âœ… ${data.message} ë‚¨ì€ ë„í† ë¦¬: ${data.remainingAcorn}`);
      location.reload(); // í˜ì´ì§€ ê°±ì‹ 
    })
    .catch(err => {
      alert(`â— ì˜¤ë¥˜: ${err.message}`);
    });
}
</script>

</body>
</html>
